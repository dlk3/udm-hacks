<!DOCTYPE html>
<html>
<head>
	<meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.8.0">
	<meta charset="utf-8">
	<link rel="stylesheet" href="markdown.css">
	<title>Configuring OpenVPN To Support Remote Access On A Ubiqiti Dream Machine Pro</title>
</head>
<body class="export">
	<h1>Configuring OpenVPN To Support Remote Access On A Ubiquiti Dream Machine Pro</h1>
	<p>The Unifi Dream Machine Pro (UDM) has OpenVPN installed but only enables its use for point-to-point VPN connections between the UDM  and another network. The Unifi console software does not provide a way to configue OpenVPN as a VPN server that clients on the public internet can use to access the local LAN. This can be done manually, however.  The challenge is doing so in a manner that will persist through UDM firmware upgrades and reboots.</p>
    <p>I have created a Debian package that I host in my PPA repository that applies the necessary configuration changes.  This ensures that the OpenVPN configuration changes persist and can be reapplied quickly should a major firmware change wipe them out.</p>
    <p>In addition to OpenVPN configuration changes, this package supplies <a href="https://github.com/OpenVPN/easy-rsa">OpenVPN's EasyRSA tool</a> to manage the PKI certificate authority and client certificates that are necessary to use OpenVPN.  A script is provided that generates OpenVPN profile files for the individual client devices (desktops, laptops, phones, tablets, etc.) that need to access the network.</p>
	
	<h2>Security Warning</h2>
	<p>This process is all about opening a new hole in the UDM firewall, thereby making the network that the UDM protects less secure. While I try not to do stupid stuff that exposes my network to harm, I cannot guarantee that there are no security exposures inherent in making the UDM configuration changes this package makes. Fair warning, ok?  Do not do any of this if your UDM protects a critical network. I cannot accept any responsibility for any harm that may befall anyone as a result of what I have done and documented here.</p>
	
	<h2>Installing the openvpn-server Debian package</h2>
	<p>To enable the PPA repository on the UDM, use ssh to connect to the UDM as the root user and issue these commands:</p>
	<pre><code>curl -s --compressed "https://daveking.com/udm-hacks/pgp-key.public" | gpg --dearmor | tee /etc/apt/trusted.gpg.d/udm-hacks.gpg >/dev/null
curl -s --compressed -o /etc/apt/sources.list.d/udm-hacks.list "https://daveking.com/udm-hacks/udm-hacks.list"
apt update</code></pre>
	<p>Use this command to install the openvpn-server package on the UDM:</p>
	<pre><code>apt install openvpn-server</code></pre>
	<p><b>IMPORTANT:</b>  After the installation is complete, check the hostname that is specified for the "local" option in the <code>/data/openvpn/server/openvpn-server.conf</code> file and the "HOSTNAME" variable in the <code>/data/openvpn/server/openvpn-server.defaults</code> file to be sure that the hostname used in each is a hostname that resolves to the UDM's address on the public internet.  <b>Note:</b> If the UDM has the secondary disk installed in it, then these files will be in the <code>/volume1</code> directory instead of the <code>/data</code> directory.</p>
	
	<h2>Creating OpenVPN configuration files for clients</h2>
	<p>The OpenVPN client certificate files necessary for authentication are created in the PKI on the UDM using the EasyRSA tool.  I have provided a script that performs the steps necessary to create and revoke client access.  It creates an *.ovpn file for each client.  This file is then used on the client device, with its own OpenVPN software installed, to connect to the network through OpenVPN on the UDM.</p>
	<p>Do not rely on this script if you have a large number of clients, it was only intended to support a small home network.</p>
	<p>To create an ovpn file for a new client, use ssh to connect to the UDM as the root user and issue this command:</p>
	<pre><code>mk-ovpn CLIENTNAME</code></pre>
	<p>The name of the ovpn file will be returned.  Download it and move it to the client device in a secure manner.</p>
	<p>To revoke access for an existing client, use ssh to connect to the UDM as the root user and issue this command:</p>
	<pre><code>mk-ovpn -d CLIENTNAME</code></pre>
	<p>A confirmation message will be displayed.</p>
	<p>One way to review a list of currently authorized clients would be to look at the list of files in the <code>/data/openvpn/server/pki/inline</code> directory.  Examining the content of these files can provide additional information about each client, such as the date on which its access expires.</p>
</body>
</html>
